<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - TemucoSoft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .module-card { cursor: pointer; transition: transform 0.2s; }
        .module-card:hover { transform: scale(1.05); }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark px-3">
        <a class="navbar-brand" href="#">TemucoSoft POS</a>
        <span class="navbar-text text-white">
            <span id="userDisplay">Cargando...</span> 
            <span class="badge bg-warning text-dark" id="planDisplay">...</span>
        </span>
        <button onclick="logout()" class="btn btn-outline-light btn-sm ms-3">Salir</button>
    </nav>

    <div class="container mt-5">
        <h2 class="mb-4">Panel de Control</h2>
        
        <div id="upgradeAlert" class="alert alert-info hidden">
            Est치s en el <strong>Plan B치sico</strong>. Funciones avanzadas bloqueadas.
        </div>

        <div class="row g-4" id="menuContainer">
            
            <div class="col-md-4 menu-item" data-roles="super_admin,admin_cliente,vendedor">
                <div class="card module-card text-white bg-success h-100">
                    <div class="card-body text-center">
                        <h3>游 POS / Ventas</h3>
                        <p>Realizar ventas</p>
                    </div>
                </div>
            </div>

            <div class="col-md-4 menu-item" data-roles="super_admin,admin_cliente,gerente">
                <div class="card module-card text-white bg-primary h-100">
                    <div class="card-body text-center">
                        <h3>游닍 Productos</h3>
                        <p>Cat치logo</p>
                    </div>
                </div>
            </div>

            <div class="col-md-4 menu-item" data-roles="super_admin,admin_cliente,gerente">
                <div class="card module-card text-white bg-info h-100">
                    <div class="card-body text-center">
                        <h3>游늵 Inventario</h3>
                        <p>Stock</p>
                    </div>
                </div>
            </div>

            <div class="col-md-4 menu-item" data-roles="super_admin,admin_cliente">
                <div class="card module-card text-white bg-secondary h-100">
                    <div class="card-body text-center">
                        <h3>游끽 Sucursales</h3>
                        <p>Gestionar locales</p>
                    </div>
                </div>
            </div>

            <div class="col-md-4 menu-item" data-roles="super_admin,admin_cliente,gerente" data-min-plan="Estandar">
                <div class="card module-card text-white bg-warning h-100">
                    <div class="card-body text-center">
                        <h3>游늳 Reportes</h3>
                        <p>Estad칤sticas (Plan Est치ndar+)</p>
                    </div>
                </div>
            </div>

            <div class="col-md-4 menu-item" data-roles="super_admin,admin_cliente">
                <div class="card module-card text-white bg-danger h-100">
                    <div class="card-body text-center">
                        <h3>游논 Usuarios</h3>
                        <p>Gesti칩n de personal</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function initDashboard() {
            const token = localStorage.getItem('access_token');
            if (!token) { window.location.href = '/login/'; return; }

            try {
                // Obtener datos del backend (/me/)
                const response = await fetch('/api/users/me/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Auth error');
                const user = await response.json();

                // Mostrar Info
                document.getElementById('userDisplay').innerText = `${user.username} (${user.role})`;
                document.getElementById('planDisplay').innerText = user.plan;
                if (user.plan === 'Basico') document.getElementById('upgradeAlert').classList.remove('hidden');

                // L칍GICA DE FILTRADO (Rol + Plan)
                document.querySelectorAll('.menu-item').forEach(item => {
                    const allowedRoles = item.getAttribute('data-roles').split(',');
                    const minPlan = item.getAttribute('data-min-plan');
                    let show = false;

                    // 1. Chequeo de Rol
                    if (allowedRoles.includes(user.role)) show = true;

                    // 2. Chequeo de Plan (Si aplica)
                    if (minPlan && show) {
                        if (user.plan === 'Basico' && (minPlan === 'Estandar' || minPlan === 'Premium')) show = false;
                        if (user.plan === 'Estandar' && minPlan === 'Premium') show = false;
                    }

                    if (!show) item.classList.add('hidden');
                });

            } catch (error) {
                localStorage.removeItem('access_token');
                window.location.href = '/login/';
            }
        }
        function logout() { localStorage.removeItem('access_token'); window.location.href = '/login/'; }
        initDashboard();
    </script>
</body>
</html>